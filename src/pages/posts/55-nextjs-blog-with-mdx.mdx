import PostUtil from "../../utils/postUtil";
import PostLayout from "../../components/post/PostLayout";
import Caption from "../../components/mdx/Caption";
import WavyLine from "../../components/WavyLine"

# MDX란?

MDX는 마크다운 컨텐츠에 JSX 문법을 사용할 수 있는 문법입니다. JSX는 React에서 사용되는 문법으로, HTML과 유사한 문법을 사용해 React Element를 생성할 수 있습니다.

다시 말해, MDX는 마크다운 컨텐츠 안에 React Element를 삽입할 수 있도록 해줍니다. 뿐만 아니라 자바스크립트 문법도 사용할 수 있기 때문에, 매우 유연하고 활용성이 좋습니다.

MDX에서는 ESM에서 제공하는 `import`, `export` 문법도 지원합니다. 그래서 외부의 컴포넌트를 mdx 안에서 재사용할 수도 있고, mdx가 어떤 값을 export하게 할 수도 있고, mdx로 작성된 글을 어떤 리액트 컴포넌트에 감싸서 export할 수도 있습니다.

## MDX로 블로그 포스팅을 하면서 불편했던 것들

그렇지만 mdx가 마냥 편하지만은 않았습니다. 제가 느낀 불편한 점은 다음과 같습니다.

### 1. 포스트 작성 중 import, export가 맨 앞에 오면 에러가 발생함

특히 자바스크립트와 관련된 포스트를 작성할 때 불편한 점입니다.

위에서 mdx는 `import`, `export` 문법을 지원한다고 했는데, 그렇기 때문에 줄의 맨 앞에 `import`나 `export`가 있으면 그 뒤에 오는 것을 *정말로 import 혹은 export 하려고 합니다.*

![mdx import error](/image/55-mdx-import-err.png)

mdx 형식으로 바로 글을 쓸 때는 에러가 발생한 부분을 바로 확인할 수 있지만, 다른 마크다운 에디터에서 글을 작성한 후 글을 붙여 넣을 때는 에러의 원인을 찾기 어려울 때가 있습니다.

# Next.js와 mdx 함께 설정하기

우선 원하는 패키지 관리자를 사용해 Next.js 프로젝트를 생성합니다. TypeScript 기반으로 생성하시려면, `--ts` 플래그를 추가합니다.

```
npx create-next-app@latest
# or
yarn create next-app
# or
pnpm create next-app
```

![mdx import error](/image/55-next-initial-setting.png)

사용하지 않을 파일과 코드를 정리해줬습니다.

<WavyLine size={4} />

## 패키지 설치

mdx를 사용하기 위해서는 패키지 몇 개를 설치해야 합니다.

```
npm install @next/mdx @mdx-js/loader @mdx-js/react
```

- `@mdx-js/loader`: MDX를 지원하는 webpack loader입니다. Next.js는 webpack을 사용하는데, webpack은 자바스크립트 이외의 파일을 읽으려면 loader가 필요합니다.

![webpack load된 mdx 파일](/image/55-mdx-webpack.png)

<Caption>원래 .mdx였던 파일이 빌드 이후에는 js 파일이 되었습니다</Caption>

- `@mdx-js/react`

MDX에서는 마크다운 문법으로 작성된 내용이 HTML로 변환될 때, HTML 태그를 특정 컴포넌트로 대체할 수 있습니다.

대체할 컴포넌트는 mdx 컴포넌트에 `components` prop으로 전달할 수 있습니다.

```jsx
import Post from "0-nginx-routing-hosting-name.mdx";

// 이렇게 하면, 이 포스트에서 인용구(blockquote)의 글자색은 빨간색이 된다.
<Post components={{blockquote: ({children}) => <blockquote style={{color: 'red'}}>{children}</blockquote>}} />
```

그러나 MDX 컴포넌트에 바로 `components` prop을 전달하기 어려운 경우가 있습니다. Next.js 처럼 file-system 라우팅을 사용해서 mdx 파일 그 자체가 페이지가 되는 경우입니다.

이 경우에는 `@mdx-js/react` 패키지를 사용해서 MDX Provider를 제공할 수 있습니다. MDX Provider로 감싸진 MDX 컴포넌트는 자동으로 `components` prop을 전달받습니다.

<WavyLine size={4} />

## 웹팩 설정하기

우선 테스트를 위해 `test.mdx` 파일을 `pages/` 하위에 하나 생성해 주겠습니다. 내용은 아래와 같습니다.
```jsx
# 안녕!

테스트 mdx 파일입니다.

<button onClick={() => alert('된다!')}>JSX 문법도 잘 동작할까요?</button>
```

`http://localhost:3000/test` 경로로 들어가 보면, 아래와 같은 에러가 발생합니다.

![webpack load된 mdx 파일](/image/55-mdx-err-no-webpack.png)

webpack loader를 설정해 주지 않았기 때문에, webpack이 mdx 파일을 제대로 처리하지 못했습니다.

webpack이 mdx를 잘 처리해 줄 수 있도록 webpack 설정을 추가해 주어야 합니다. Next.js에서는 next.config.js를 수정해서 webpack 설정을 편하게 수정할 수 있습니다.

```js
// next.config.js

/** @type {import('next').NextConfig} */
// 여기에는 일반적인 Next.js 설정을 넣습니다.
const nextConfig = {
  reactStrictMode: true,
  pageExtensions: ["js", "jsx", "ts", "tsx", "md", "mdx"],
};

// 여기서는 mdx 로더 설정을 위한 HOC를 만듭니다.
// eslint-disable-next-line @typescript-eslint/no-var-requires
const withMdx = require("@next/mdx")({
  extension: /\.mdx?$/,
  options: {
    remarkPlugins: [],
    rehypePlugins: [],
  },
});

// mdx 로더 HOC로 일반 Next.js 설정을 감쌉니다.
module.exports = withMdx(nextConfig);
```

![webpack load된 mdx 파일](/image/55-mdx-working.png)

웹팩 로더를 추가해 주면, 이제 mdx 파일을 정상적으로 확인할 수 있습니다.

<WavyLine size={4} />

## 마크다운 컴포넌트 커스텀하기




export const meta = PostUtil.createPostMeta({
    index: 55,
    title: "Next.js와 mdx로 블로그 만들기",
    description: "Next.js로 정적 사이트 블로그를 만들고, 글은 mdx로 유연하게 작성한다.",
    category: '',
    series: "Blog",
    tags: ["JavaScript", "Next.js", "mdx"], // # 포함하지 않는 string array
    postedAt: '2022. 10. 12.',
});
export default ({children}) => <PostLayout meta={meta}>{children}</PostLayout>